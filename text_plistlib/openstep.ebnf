# TatSu EBNF grammar for ASCII OpenStep/GNUStep property lists.
# @see https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/PropertyLists/OldStylePlists/OldStylePLists.html
# @see http://www.gnustep.org/resources/documentation/Developer/Base/Reference/NSPropertyList.html
# @see https://github.com/gnustep/libs-base/blob/master/Source/NSPropertyList.m
@@grammar::Plist
@@comments :: ?'/\*.*?\*/'
@@eol_comments :: ?'//.*?$'
@@nameguard :: False

# s: strings
# v: vanilla value
start = (v:value $) | (s:{ entry } $);

entry::Entry = k:string '=' v:value ';';

value = dict | array | string | hexdata | base64data | typed;
dict::DictType = '{' @:{ entry } '}';
array::ArrayType = '(' @:','.{ value } [ ',' ]')'; # trailing comma is my extension
hexdata::BinType = '<' @:{ hexpairs } '>';
base64data::BinType = '<[' @:/[^\]]*/ ']>';
typed = '<*' @:typed_belly '>';

hexpairs = ?'(?i)([0-9a-f]{2})+';

# gsQuotable 
safechar = ?'[-#!$%&*+./0-9:?@A-Z^_a-z|~]+';

# string
string::StringType = (sc:safechar) | ('"' ~ ec:{ qchar } '"' ~);

qchar = r:(/[^"\\]+/) | e:(?'\\' esc_seq);
esc_seq = ?'[abtrnvf]'
        | (?'(?i)u' ?'(?i)[0-9a-f]{4}')
        | (?'x' ?'(?i)[0-9a-f]{2}')
        | ?'[0-7]{,3}'
        | ?'.'
        ;

# GNUStep typed
number = /[0-9]+/;
int::int = [ '-' ] number;
float::float = [ '-' ] ( /(?i)nan/ | /(?i)inf/ |
    (number [ '.' [number] ] | '.' number) [ 'e' [ '[+-]' number ] ]
 );
date::DateType = /[^>]+/;

# Use Regexp here to skip nameguard
typed_belly = 
    ?'I' @:int |
    ?'R' @:float |
    ?'B' @:?'[YN]' |
    ?'D' @:date; # 2006-01-02 15:04:05 -0700